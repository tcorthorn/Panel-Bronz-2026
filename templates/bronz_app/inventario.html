{% extends 'bronz_app/base.html' %}

{% block content %}
<h2 class="mb-4 text-center">Inventario Actual</h2>
<div class="row mb-3">
    <div class="col-md-6">
        <form method="get" class="d-flex">
            <input type="text" name="q" class="form-control me-2" placeholder="Buscar SKU, Categoría o Producto" value="{{ q }}">
            <button type="submit" class="btn btn-outline-secondary">Buscar</button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_excel }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle border rounded">
       <thead class="table-dark">
        <tr>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=sku&dir={% if sort == 'sku' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    SKU
                    {% if sort == 'sku' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=categoria&dir={% if sort == 'categoria' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Categoría
                    {% if sort == 'categoria' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=producto&dir={% if sort == 'producto' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Producto
                    {% if sort == 'producto' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=inicial&dir={% if sort == 'inicial' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Inicial
                    {% if sort == 'inicial' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=bodega&dir={% if sort == 'bodega' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Bodega
                    {% if sort == 'bodega' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=ingresos&dir={% if sort == 'ingresos' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Ingresos
                    {% if sort == 'ingresos' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=envios&dir={% if sort == 'envios' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Envios
                    {% if sort == 'envios' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=ventas&dir={% if sort == 'ventas' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Ventas
                    {% if sort == 'ventas' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=ajustes&dir={% if sort == 'ajustes' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Ajustes
                    {% if sort == 'ajustes' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=en_oficina&dir={% if sort == 'en_oficina' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    En Oficina
                    {% if sort == 'en_oficina' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=en_bodega&dir={% if sort == 'en_bodega' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    En Bodega
                    {% if sort == 'en_bodega' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            <th>
                <a class="text-white" href="?q={{ q }}&sort=ajuste_ventas&dir={% if sort == 'ajuste_ventas' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Ajuste Ventas
                    {% if sort == 'ajuste_ventas' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    S{% endif %}
    </a>
</th>

            <th>
                <a class="text-white" href="?q={{ q }}&sort=total&dir={% if sort == 'total' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                    Total
                    {% if sort == 'total' %}
                        {% if direction == 'asc' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>
        </tr>
        </thead>

        <tbody>
        {% for p in productos_page %}
            <tr>
                <td>{{ p.sku }}</td>
                <td>{{ p.categoria }}</td>
                <td>{{ p.producto }}</td>
                <td>{{ p.inicial }}</td>
                <td>{{ p.bodega }}</td>
                <td>{{ p.ingresos }}</td>
                <td>{{ p.envios }}</td>
                <td>{{ p.ventas }}</td>
                <td>{{ p.ajustes }}</td>
                <td>{{ p.en_oficina }}</td>
                <td>{{ p.en_bodega }}</td>
                <td>{{ p.ajuste_ventas }}</td>
                <td><strong>{{ p.total }}</strong></td>
            </tr>
        {% empty %}
            <tr><td colspan="13" class="text-center">Sin resultados</td></tr>
        {% endfor %}

        <!-- Totales de la página actual -->
        <tr class="table-info fw-bold">
            <td colspan="3" class="text-end">Totales de esta página:</td>
            <td>{{ total_inicial }}</td>
            <td>{{ total_bodega }}</td>
            <td>{{ total_ingresos }}</td>
            <td>{{ total_envios }}</td>
            <td>{{ total_ventas }}</td>
            <td>{{ total_ajustes }}</td>
            <td>{{ total_en_oficina }}</td>
            <td>{{ total_en_bodega }}</td>
            <td>{{ total_ajuste_ventas }}</td>
            <td>{{ total_total }}</td>
        </tr>
        <!-- Totales globales del filtro -->
        <tr class="table-success fw-bold">
            <td colspan="3" class="text-end">Totales de todos los resultados filtrados:</td>
            <td>{{ global_total_inicial }}</td>
            <td>{{ global_total_bodega }}</td>
            <td>{{ global_total_ingresos }}</td>
            <td>{{ global_total_envios }}</td>
            <td>{{ global_total_ventas }}</td>
            <td>{{ global_total_ajustes }}</td>
            <td>{{ global_total_en_oficina }}</td>
            <td>{{ global_total_en_bodega }}</td>
            <td>{{ global_total_ajuste_ventas }}</td>
            <td>{{ global_total_total }}</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Paginación -->
<nav>
    <ul class="pagination justify-content-center">
        {% if productos_page.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?q={{ q }}&sort={{ sort }}&dir={{ direction }}&page=1">Primero</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?q={{ q }}&sort={{ sort }}&dir={{ direction }}&page={{ productos_page.previous_page_number }}">Anterior</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Primero</span></li>
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}
        <li class="page-item active">
            <span class="page-link">{{ productos_page.number }} / {{ productos_page.paginator.num_pages }}</span>
        </li>
        {% if productos_page.has_next %}
            <li class="page-item">
                <a class="page-link" href="?q={{ q }}&sort={{ sort }}&dir={{ direction }}&page={{ productos_page.next_page_number }}">Siguiente</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?q={{ q }}&sort={{ sort }}&dir={{ direction }}&page={{ productos_page.paginator.num_pages }}">Último</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
            <li class="page-item disabled"><span class="page-link">Último</span></li>
        {% endif %}
    </ul>
</nav>
<div class="mt-4">
    <a href="{% url 'home' %}" class="btn btn-outline-primary">Volver al inicio</a>
</div>
{% endblock %}
